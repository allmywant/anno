<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>Community MVP</title>
    <link type="text/css" href="./css/style.css" rel="stylesheet" />
    <script type="text/javascript">
        var dojoConfig = {
            parseOnLoad:false,
            mblHideAddressBar:false,
            mblAndroidWorkaround:false,
            mblAlwaysHideAddressBar:false,
            async:1,
            mblUserAgent: 'iPhone'
        };
    </script>
    <script type="text/javascript" src="../../scripts/dojo/dojo.js"></script>
    <script>
        require([ "dojox/mobile/deviceTheme","dojox/mvc/at", "./main.js" ], function(deviceTheme, at) {

        });
    </script>
    <script type="text/javascript">
        var apiVersion = "1.0";
        var currentUserInfo = {email:''};
        function gce_init()
        {
            console.error(document.location.href);

            var ROOT = 'https://usersource-anno.appspot.com/_ah/api';
            gapi.client.load('anno', apiVersion, function(yy) {
                console.error("Anno API loaded.");
                checkLoadReady();
            }, ROOT);

            gapi.client.load('followup', apiVersion, function() {

            }, ROOT);

            gapi.client.load('vote', apiVersion, function() {

            }, ROOT);

            gapi.client.load('flag', apiVersion, function() {

            }, ROOT);
        }

        function checkLoadReady()
        {
            if (window.loadListData)
            {
                window.loadListData();
            }
            else
            {
                window.setTimeout(checkLoadReady, 50);
            }
        }
    </script>
    <script type="text/javascript" src="../../scripts/gce.js"></script>
    <script type="text/javascript" src="cordova-min.js"></script>
    <script type="text/javascript" src="../../childbrowser.js"></script>
    <script type="text/javascript">
        var oauthOptions = {
            client_id: '955803277195.apps.googleusercontent.com',
            client_secret: 'l5UwDYJuv2BdUUBF2tu9fsol',
            redirect_uri: 'http://localhost', //postmessage
            scope: 'https://www.googleapis.com/auth/userinfo.email'
        };
        require(["dojo/ready", "dojo/request/xhr"], function(ready, xhr){
            var checkAuth = function()
            {
                var authUrl = 'https://accounts.google.com/o/oauth2/auth?' +
                        "client_id="+oauthOptions.client_id+
                        "&redirect_uri="+oauthOptions.redirect_uri+
                        "&response_type=code"+
                        "&origin=http://localhost:8080"+
                        "&scope="+oauthOptions.scope;

                window.plugins.childBrowser.onLocationChange = checkCode;
                window.plugins.childBrowser.showWebPage(authUrl, { showLocationBar: false,showAddress:false,showNavigationBar:false });
            };

            var checkCoding = false;
            var checkCode = function(url)
            {
                var code = /\?code=(.+)$/.exec(url);
                var error = /\?error=(.+)$/.exec(url);

                if (code || error) {
                    //Always close the browser when match is found
                    console.error(code[1]);
                    window.plugins.childBrowser.close();
                }

                if (code) {
                    if (checkCoding) return;
                    checkCoding = true;
                    //Exchange the authorization code for an access token
                    xhr.post('https://accounts.google.com/o/oauth2/token', {
                        data:{
                            code: code[1],
                            client_id: oauthOptions.client_id,
                            client_secret: oauthOptions.client_secret,
                            redirect_uri: oauthOptions.redirect_uri,
                            grant_type: 'authorization_code'
                        },
                        handleAs:"json"
                    }).then(function(data) {
                                console.error("post res: "+JSON.stringify(data));
                                gapi.auth.setToken(data);
                                getUserInfo();
                            }, function(err){
                                console.error("post res error: "+err);
                                alert("Get access token error: "+err);
                            });
                } else if (error) {
                    console.error("error: "+error[1]);
                }
            };

            var getUserInfo = function()
            {
                gapi.client.load('oauth2', 'v2', function() {
                    console.error("oauth loaded");
                    var request = gapi.client.oauth2.userinfo.get();
                    request.execute(function(userinfo){
                        console.error("get userinfo res: "+ userinfo);
                        if (userinfo.error)
                        {
                            alert("Get userinfo failed: "+ userinfo.error.message);
                            return;
                        }

                        currentUserInfo = userinfo;
                    });
                });
            };

            document.addEventListener('deviceready', checkAuth, false);
        });
    </script>

    <script type="text/javascript" src="heartcode-canvasloader-min.js"></script>
</head>
<body id="container">
<!--<div id="loadingMessageDiv" style="width:300px;margin-top: 20px;margin-left:20px;">Loading...</div>-->
<div id="lightCover" class="lightCover" style="display: none;"></div>
<div id="lightCoverScreenshot" class="lightCoverScreenshot" style="display: none;"></div>
<input id="appNameTextBox" style="display: none;z-index: 4000;position: absolute;" type="text" data-dojo-type="dojox/mobile/TextBox" class="commentTextbox" placeholder="Type app name here">
<button id="hiddenBtn" style="position: absolute;left:-2000px;top: -2000px;">a</button>
<div id="toastMsgContainer" style="display: none;" class="toastMsgContainer"></div>
<div id="bottomPlaceholder" style="background-color: transparent;width: 100%;height: 30px;position: absolute;bottom: 0px;left: 0px;z-index: 2001"></div>
</body>
</html>
